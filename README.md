# Improving remote access to Sentinel-2 imagery

Currently, the JP2 files generated by the Sentinel-2 processors (L1C, L2A) do not utilize the TLM feature of JP2. The TLM marker ([doc section A.7.1](https://www.itu.int/rec/dologin_pub.asp?lang=e&id=T-REC-T.800-202407-I!!PDF-E&type=items)) is located in the main header of the JP2 file, and provides the location and length of each tile within the file. It is optional, but if present it is used by decoders when reading only part of the image. Without the TLM marker, the decoder has to go through each tile, leading to a lot of requests, bandwidth and time wasted. The TLM marker itself is very small (<1KB), and can be enabled with an option during encoding.

Support for efficient decoding with TLM markers was recently added in [OpenJPEG](https://github.com/uclouvain/openjpeg/blob/v2.5.3/NEWS.md#openjpeg-253-dec-2024).
This is particularly important when considering remote access (including on CDSE and S3).

## Benchmark

We compare access time to a small crop (500x500) inside a B03 raster, without TLM (current Sentinel-2 setting), with TLM (manually added, see below), and with a COG.

| Format | Time Taken | Bandwidth Used | Number of Requests |
|--------|------------|----------------|---------------------|
| JP2 without TLM | 4325ms | ~3MB | 110 |
| JP2 with TLM | 391ms | ~1MB | 3 |
| COG | 389ms | ~1.5MB | 2 |

Exact timings varies depending on the internet connection, but cropping a file with TLM will always be faster and requires less requests.
Enabling this option would make CDSE quotas for General Users more adequate, as well as reduce the load for CDSE infrastructure, including OpenEO.


The shell script [benchmark.sh](./benchmark.sh) provides a reproducible experiment that compares the reading times of a Sentinel-2 image chunk with and without TLM markers (from product `S2B_MSIL2A_20241115T100159_N0511_R122_T32TQM_20241115T125542`):

```bash
bash benchmark.sh
```

The sample file `./T32TQM_20241115T100159_B03_10m_with_TLM.jp2` was generated by injecting a computed TLM table into the original JP2 file. One can also use GDAL with JP2OpenJPEG driver with the following command:
```bash
gdal_translate  -co TLM=ON -co REVERSIBLE=YES -co YCBCR420=NO -co QUALITY=100 -co PLT=ON -co PRECINCTS='{256,256},{256,256},{256,256},{256,256},{256,256}' -co RESOLUTIONS=5 -co PROFILE=UNRESTRICTED -co JPX=OFF T32TQM_20241115T100159_B03_10m.jp2 T32TQM_20241115T100159_B03_10m_with_TLM.jp2
```

According to the [Kakadu usage examples](https://kakadusoftware.com/wp-content/uploads/Usage_Examples.txt), the `ORGgen_tlm` option allows to control the generation of the TLM segment.
